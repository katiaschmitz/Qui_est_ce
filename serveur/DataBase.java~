import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.PreparedStatement;

/****export CLASSPATH=.:~/final/qui_est_ce/serveur/jdbc.jar
mysql -h  mysql-thetourist.alwaysdata.net thetourist_quiestce -u 107510_3 -p  root
 ****/

/**
 * Classe DataBase est un module dans le cadre du jeu du Qui_Est_Ce projet de licence informatique 3ème année
 *
 * @author     Mehdi Naima
 * @version    1.0
 * @since      May 2015
 */

public class DataBase
{
	private Connection connexion;



	/**
	 * Initialise une instance de base de donnee
	 * @param  connexion pour initialiser la connexion à la base de donnee
	 */
	public DataBase()
	{
		 System.out.println("Connecting to a selected database...");
		String driver = "com.mysql.jdbc.Driver";
		/*String url = "jdbc:mysql://marseille/BDE11216832";
    		String user = "E11216832";
    		String password = "0JYJQM054H1";*/

			String url = "jdbc:mysql://mysql-thetourist.alwaysdata.net/thetourist_quiestce";
    		String user = "107510_3";
    		String password = "root";

		try
		{
			try{Class.forName(driver);}
			catch(ClassNotFoundException e){System.out.println("probleme driver");}
			connexion = DriverManager.getConnection(url,user,password);
			System.out.println("Connected database successfully...");
			/*PreparedStatement req;
			String sql = "";
			sql = "create table qui_est_ce (pseudo varchar(20),password varchar(20),gagne int,perdu int,rang int,connecte int)";
			req=connexion.prepareStatement(sql);
			req.executeUpdate(sql);
	  	    System.out.println("table created...");*/

		}
		catch (SQLException ex)
		{
			System.out.println("probleme connexion base de donnee");
			System.out.println("SQLException: " + ex.getMessage());
			System.out.println("SQLState: " + ex.getSQLState());
			System.out.println("VendorError: " + ex.getErrorCode());
        	}
		/*verifierExistencePersonnes();*/
		/*creerTablePersonnes();*/

	}


	/**
	 * verifie si un pseudo et un mot de passe correspondent bien a un utilisateur
	 * @param  pseudo le pseudo a verifier
	 * @param  password le mot de passe
	 * @return  vrai si la personne existe, faux sinon
	 */
	public boolean connexion(String pseudo,String password)
	{
		System.out.println("DataBase:connexion debut methode ");
		int reponse;
		boolean x=false;
		PreparedStatement req;
		try
		{
			req=connexion.prepareStatement("Select count(*) as n from qui_est_ce where pseudo=? and password=?;");
			req.setString( 1, pseudo);
			req.setString( 2, password);
			ResultSet resultat = req.executeQuery();
		    resultat.next();
			reponse=resultat.getInt("n");
			if(reponse==1)
			{
				x=true;
				try
				{
					req=connexion.prepareStatement( "update qui_est_ce set connecte=1 where pseudo=?;");
					req.setString( 1, pseudo );
					int res = req.executeUpdate();
				}
				catch(SQLException ex){}

			}
			else
				x=false;

		}
		catch(SQLException ex){}

		/*while ( resultat.next() )*/

		System.out.println("DataBase:connexion fin methode "+x);

		return x;
	}

	/**
	 * inscrit pseudo et un mot de passe dans la base de donnee
	 * @param  pseudo le pseudo a verifier
	 * @param  password le mot de passe
	 * @return  vrai si la personne a bien ete ajoutee la personne existe, et faux si le pseudo est deja utilise
	 */
	public boolean inscription(String pseudo,String password)
	{
		System.out.println("DataBase:inscription debut methode ");

		boolean x=false;
		int reponse;
		PreparedStatement req=null;
		try
		{
			req=connexion.prepareStatement( "Select count(*) as n from qui_est_ce where pseudo=?");
			req.setString( 1, pseudo );
			ResultSet resultat = req.executeQuery();
		   	resultat.next();
			reponse=resultat.getInt("n");
			System.out.println("reponse = "+reponse);

			if(reponse==1)
				x=false;
			else
			{
				PreparedStatement inscrip=null;
				try
				{
					int indice=recupererNombre();
					inscrip=connexion.prepareStatement("INSERT INTO qui_est_ce VALUES(?,?,0,0,?,1)");
					inscrip.setString(1,pseudo);
					inscrip.setString(2,password);
					inscrip.setInt(3,indice);
					int res = inscrip.executeUpdate();
					x=true;
					arrangerClassement(pseudo);

				
				}
				catch(SQLException ex){	ex.printStackTrace();System.out.println("erreur inscription 1ere requete");}
			}

		}
		catch(SQLException ex){ex.printStackTrace();System.out.println("erreur inscription 2eme requete ");}
		System.out.println("DataBase: fin inscription");

		return x;

	}

	/**
	 * renvoie la liste d attente des personnes connectee avec leur nombre de victoires et defaites
	 * @param  pseudo la personne qui demande la liste, qu on ne renverra pas dans la liste
	 * @return  une chaine de caracteres avec des ':' entre chaque personnes et des ' ' entre le nom,victoires et defaites de chaque personne
	 */
	public String listeJoueur(String pseudo)
	{
		System.out.println("DataBase:liste Joueur debut methode ");
		String reponse="";
		PreparedStatement req=null;
		try
		{
			req=connexion.prepareStatement( "Select pseudo from qui_est_ce where pseudo<>? and connecte=1;");


			req.setString( 1, pseudo );
			ResultSet resultat = req.executeQuery();
			while ( resultat.next())
			{
				reponse=reponse+":"+resultat.getString("pseudo");
			}

		}
		catch(SQLException ex){}
		System.out.println("fin liste attente");
		System.out.println("DataBase:liste Joueur fin methode "+reponse);

		return reponse;
	}

	public void deconnexion(String pseudo)
	{
		PreparedStatement req;
		try
		{
			req=connexion.prepareStatement( "UPDATE qui_est_ce set connecte=0 where pseudo=?");
			req.setString( 1, pseudo );
			int resultat = req.executeUpdate();
		}
		catch(SQLException ex){}

	}



	public void fermerConnection()
	{
		try{connexion.close();}
		catch(SQLException ex){}

	}


	public void majScore(String pseudo,boolean gagne)
	{
		PreparedStatement req=null;
		int nombre=-1;
		try
		{
			if(gagne)
			{
				req=connexion.prepareStatement( "select gagne from qui_est_ce where pseudo=?");
				req.setString( 1, pseudo );
				ResultSet resultat = req.executeQuery();
		    		resultat.next();
				nombre=resultat.getInt("gagne");
				nombre++;
				req=connexion.prepareStatement( "update qui_est_ce set gagne=? where pseudo=?");
				req.setInt(1 , nombre );
				req.setString( 2, pseudo );
				req.executeUpdate();


			}

			else
			{
				req=connexion.prepareStatement( "select perdu from qui_est_ce where pseudo=?");
				req.setString( 1, pseudo );
				ResultSet resultat = req.executeQuery();
		    		resultat.next();
				nombre=resultat.getInt("perdu");
				nombre++;
				req=connexion.prepareStatement( "update qui_est_ce set perdu=? where pseudo=?");
				req.setInt(1 , nombre );
				req.setString( 2, pseudo );
				req.executeUpdate();


			}
			arrangerClassement(pseudo);

		}
		catch(SQLException ex){}

	}

	public String afficherScore(String pseudo)
	{
		PreparedStatement req=null;
		int i;
		String reponse = "";
		int g;
		int p;
		String ps="";

		try
		{
			for(i=0;i<recupererNombre();i++)
			{
			req=connexion.prepareStatement( "select pseudo,gagne,perdu from qui_est_ce where rang = ?");
			req.setInt( 1, i );
			ResultSet resultat = req.executeQuery();
			resultat.next();
			g=resultat.getInt("gagne");
			p=resultat.getInt("perdu");
			ps = resultat.getString("pseudo");
			reponse = reponse + ":" +ps +" "+g+" "+p;

			}
		}
		catch(SQLException ex){}


		return reponse;
	}


	public void arrangerClassement(String pseudo)
	{
		int i=-1;
		int dif=-1;
		PreparedStatement req=null;
		int indice=-1;
		boolean x=false;
		try
		{
			req=connexion.prepareStatement( "select rang,(gagne-perdu) as dif from qui_est_ce where pseudo=?");
			req.setString( 1, pseudo );
			ResultSet resultat = req.executeQuery();
	    		resultat.next();
	    		dif=resultat.getInt("dif");
	    		indice=resultat.getInt("rang");
	    		System.out.println("difference = "+dif);
	    		System.out.println("indice = "+indice);

		}
		catch(SQLException ex){}
		decalerHaut(indice,pseudo);
		int taille=recupererNombre()-1;
		int[] tab=new int[taille];
		remplirTableau(tab,pseudo);
		for(i=0;i<tab.length;i++)
	    		System.out.println("tab["+i+"] = "+tab[i]);
		for(i=0;i<taille && x==false ;i++)
		{
			if(dif>tab[i])
			{
				x=true;
				decalerBas(i);	
				setRang(pseudo,i);				
			}
		}
		if(x==false)
		{

		}
		/*System.out.println("taille"+recupererNombre());
		int taille=recupererNombre();
		int[] tab=new int[taille];
		remplirTableau(tab,pseudo);
		for(i=0;i<tab.length;i++)
	    		System.out.println("tab["+i+"] = "+tab[i]);

		for(i=0;i<taille && x==false ;i++)
		{
			
				if(dif>tab[i])
				{
					x=true;
					setRang(pseudo,indice,i);
					

				}

			
		}
		if(x==false)
			setRang(pseudo,indice,i-1);		
		System.out.println("x = true a i = "+i);*/

	}



	public void decalerHaut(int i,String pseudo)
	{
		
		PreparedStatement req=null;
		try
		{
				
				req=connexion.prepareStatement( "update qui_est_ce set rang=rang-1 where rang>?");
				req.setInt( 1, i );
				req.executeUpdate();
		}
		catch(SQLException ex){}
		try
		{
				
				req=connexion.prepareStatement( "update qui_est_ce set rang=-1 where pseudo=?");
				req.setString( 1, pseudo );
				req.executeUpdate();
		}
		catch(SQLException ex){}

	}

	public void decalerBas(int i)
	{
		
		PreparedStatement req=null;
		try
		{
				
				req=connexion.prepareStatement( "update qui_est_ce set rang=rang+1 where rang>=?");
				req.setInt( 1, i );
				req.executeUpdate();
		}
		catch(SQLException ex){}
	}




	public void setRang(String pseudo,int i)
	{


	
		PreparedStatement req=null;
		try
		{
				req=connexion.prepareStatement( "update qui_est_ce set rang=? where pseudo=?");
				req.setInt( 1, i );
				req.setString( 2, pseudo );
				req.executeUpdate();
		}
		catch(SQLException ex){}

	}


	public void decalerScore(int debut,int fin,String pseudo,int x)
	{
		System.out.println("x= "+x);

		PreparedStatement req=null;
		try
		{
				if(x==1)
				{
				req=connexion.prepareStatement( "update qui_est_ce set rang=rang+1 where rang>=? and rang<? and pseudo<>?");
				req.setInt( 1, fin );
				req.setInt( 2, debut );
				req.setString( 3,pseudo );

				}
				else
				{
				req=connexion.prepareStatement( "update qui_est_ce set rang=rang-1 where rang>? and rang<=? and pseudo<>?");

				req.setInt( 1, debut );
				req.setInt( 2, fin );
				req.setString( 3,pseudo );

				}
				req.executeUpdate();
		}
		catch(SQLException ex){}

	}


	public void remplirTableau(int[] tab,String pseudo)
	{
		PreparedStatement req=null;
		int i;
		try
		{
			req=connexion.prepareStatement( "select rang,(gagne-perdu) as dif from qui_est_ce where pseudo<>?");
			req.setString( 1,pseudo);
			ResultSet resultat = req.executeQuery();
			for(i=0;i<tab.length;i++)
			{

				resultat.next();
				tab[resultat.getInt("rang")]=resultat.getInt("dif");
				
				
			}
		}
		catch(SQLException ex){}

	}



	public int recupererNombre()
	{
		PreparedStatement req=null;
		int nombre=-1;
		try
		{
				req=connexion.prepareStatement( "select count(*) as n from qui_est_ce");
				ResultSet resultat = req.executeQuery();
				resultat.next();
	    		nombre=resultat.getInt("n");
		}
		catch(SQLException ex){}
		return nombre;


	}

	public void deconncterTous()
	{
		PreparedStatement req=null;
		try
		{
				req=connexion.prepareStatement( "update qui_est_ce set connecte=0 where connecte=1");
				req.executeUpdate();
		}
		catch(SQLException ex){		System.out.println("x= aux");}


	}

/***************************************ajout*********************************/

	public String listeQuestion(String mode)
	{
		PreparedStatement req=null;
		int i;
		String reponse = "";
		int g;
		int p;
		String ps="";

		try
		{
			for(i=0;i<recupererNombre();i++)
			{
			req=connexion.prepareStatement( "select q from question_"+mode);
			ResultSet resultat = req.executeQuery();
			while ( resultat.next())
			{
				reponse=reponse+":"+resultat.getString("q");
			}

			ps = resultat.getString("q");
			reponse = reponse + ":" +ps;

			}
		}
		catch(SQLException ex){}


		return reponse;
	}


	public int[] getChampReponse( int id_question, String mode )
	{
		PreparedStatement req=null;
		int[] nombre= {-1,-1} ;
		try
		{
			req=connexion.prepareStatement( "select r,ref  from question_"+mode+" where id = ?");
			req.setInt(1,id_question);
			ResultSet resultat = req.executeQuery();
			resultat.next();
	    		nombre[0]=resultat.getInt("r");
	    		nombre[1] = resultat.getInt("ref");
		}
		catch(SQLException ex){}
		System.out.println("champ" + nombre[0] + " valeur"+ nombre[1]);
		return nombre;

	}


	public boolean verifierImage(int id_image, int num_champs,int br, boolean correct,String m)
	{
		PreparedStatement req=null;
		boolean x = false;
		String ch="champ"+num_champs;
		int res;

		if(correct)
		{
			try
			{
				req=connexion.prepareStatement( "select "+ch+" as rep from image_"+m+" where id=?");
				req.setInt(1,id_image);
				ResultSet resultat = req.executeQuery();
				resultat.next();
	    		res=resultat.getInt("rep");
	    		if(res!=br)
	    			x=true;
	    		else
	    			x=false;

			}
			catch(SQLException ex){}
		}
		else
		{
			try
			{
				req=connexion.prepareStatement( "select "+ch+" as rep from image_"+m+" where id=?");
				req.setInt(1,id_image);
				ResultSet resultat = req.executeQuery();
				resultat.next();
	    		res=resultat.getInt("rep");
	    		if(res==br)
	    			x=true;
	    		else
	    			x=false;

			}
			catch(SQLException ex){}
		}
		return x;
	}

	public int getNombreQuestion(String mode)
	{

		PreparedStatement req=null;
		int nombre=-1;
		try
		{
			req=connexion.prepareStatement( "select count(*) as n from question_"+mode);
			ResultSet resultat = req.executeQuery();
			resultat.next();
	    		nombre=resultat.getInt("n");
		}
		catch(SQLException ex){}
		return nombre;


	}

	public int getBonneReponse( int id_img,int champ,String m)
	{
		System.out.println("id_image = "+id_img+" champ"+champ);
		String col = "champ"+champ;
		System.out.println("**"+col+"**");

		PreparedStatement req=null;
		int nombre=-1;
		try
		{
			req=connexion.prepareStatement( "select "+col+" as m from image_"+m+" where id=?");
			req.setInt(1,id_img);

			ResultSet resultat = req.executeQuery();
			resultat.next();
			System.out.println("cloche");

	    	nombre=resultat.getInt("m");
		}
		catch(SQLException ex){System.out.println("erreur getBonneReponse");}
		return nombre;

	}
	public int getNbImages(String mode)
	{
		PreparedStatement req=null;
		int nombre=-1;
		try
		{
			req=connexion.prepareStatement( "select count(*) as n from image_"+mode);
			ResultSet resultat = req.executeQuery();
			resultat.next();
	    		nombre=resultat.getInt("n");
		}
		catch(SQLException ex){System.out.println("erreur getNbImages");}
		return nombre;
	}

	public boolean ajouterFavoris(String personne,String fav)
	{
		PreparedStatement req=null;
		int nombre =-1;
		boolean x=false;
		try
		{

			req=connexion.prepareStatement( "select count(*) as n from favoris where personne=? and fav=?");
			req.setString(1,personne);
			req.setString(2,fav);
			ResultSet resultat = req.executeQuery();
			resultat.next();
		    	nombre=resultat.getInt("n");
			if(nombre==0)
			{
	
				try
				{
					req=connexion.prepareStatement( "insert into favoris values(?,?)");
					req.setString(1,personne);
					req.setString(2,fav);
					req.executeUpdate();
					x = true;
	
				}
				catch(SQLException ex){System.out.println("erreur ajouterFavoris 1ere requete");}
			}
			else
			{
				x = false;
			}
		}
		catch(SQLException ex){System.out.println("erreur ajouterFavoris 2eme requete");}
		return x;
	}


	public boolean supprimerFavoris(String personne,String fav)
	{
		PreparedStatement req=null;
		int nombre =-1;
		boolean x=false;
		try
		{

			req=connexion.prepareStatement( "select count(*) as n from favoris where personne=? and fav=?");
			req.setString(1,personne);
			req.setString(2,fav);
			ResultSet resultat = req.executeQuery();
			resultat.next();
		    	nombre=resultat.getInt("n");
			if(nombre==1)
			{
	
				try
				{
					req=connexion.prepareStatement( "delete from favoris where personne=? and fav=?");
					req.setString(1,personne);
					req.setString(2,fav);
					req.executeUpdate();
					x = true;
	
				}
				catch(SQLException ex){System.out.println("erreur supprimerFavoris 1ere requete");}
			}
			else
			{
				x = false;
			}
		}
		catch(SQLException ex){System.out.println("erreur supprimerFavoris 2eme requete");}
		return x;
	}



}












